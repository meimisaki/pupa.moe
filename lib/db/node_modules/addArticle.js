'use strict';

var Syncher = require('../../syncher');

var inspectObject = require('../../inspectObject');
var extract = require('../../extract');

var struct = require('struct');

var trimTags = require('trimTags');

function addArticle(obj, callback) {
	var client = this;
	var err = inspectObject(obj, struct.article);
	if (err) return callback(err);
	obj = extract(obj, struct.article);
	var tags = trimTags(obj);
	client.addObject('category:' + obj.category + ':article', obj, function (err, id) {
		if (err) return callback(err);
		var syncher = new Syncher();
		syncher.add(client.createIndex.bind(client, 'article', id, tags.concat(obj.title)));
		syncher.add(client.addAutocomplete.bind(client, tags));
		syncher.run(function (createArgs, addArgs) {
			var err = createArgs[0] || addArgs[0];
			if (err) return callback(err);
			callback(null, id);
		});
	});
}

module.exports = addArticle;
