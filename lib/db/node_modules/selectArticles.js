'use strict';

var Syncher = require('../../syncher');

var each = require('../../each');

function selectArticles() {
	var client = this;
	var args = Array.prototype.slice.call(arguments);
	var callback = args.pop();
	var opts = args.pop() || {};
	var key = args.shift();
	function done(err, arr) {
		if (err) return callback(err);
		var syncher = new Syncher();
		var categories = {};
		arr.forEach(function (obj) {
			obj.category && (categories[obj.category] = null);
			if (!opts.withCommentList) return ;
			syncher.add(function (fn) {
				client.selectObjects('article:' + obj.id + ':comment', {limit: -1}, function (err, arr) {
					obj.comment_list = arr;
					fn(err);
				});
			});
		});
		each(categories, function (val, key) {
			syncher.add(function (fn) {
				client.getObject('category', key, function (err, obj) {
					categories[key] = obj;
					fn(err);
				});
			});
		});
		syncher.run(function () {
			for (var key = 0 ; key < arguments.length ; ++key) {
				var err = arguments[key][0];
				if (err) return callback(err);
			}
			arr.forEach(function (obj) {
				obj.category && (obj.category = categories[obj.category]);
			});
			callback(null, arr);
		});
	}
	if (!opts.id) return client.selectObjects((key ? key + ':' : '') + 'article', opts, done);
	client.getObject('article', opts.id, function (err, obj) {
		done(err, [obj]);
	});
}

module.exports = selectArticles;
