'use strict';

var Syncher = require('../../syncher');

var inspectObject = require('../../inspectObject');
var extract = require('../../extract');

var struct = require('struct');

var trimTags = require('trimTags');

function patchArticle(id, obj, callback) {
	var client = this;
	var err = inspectObject(obj, struct.article);
	if (err) return callback(err);
	obj = extract(obj, struct.article);
	var tags = trimTags(obj);
	var syncher = new Syncher();
	syncher.add(client.patchObject.bind(client, 'article', id, obj));
	syncher.add(client.removeIndex.bind(client, 'article', id));
	syncher.add(client.addAutocomplete.bind(client, tags));
	syncher.run(function (patchArgs, removeArgs, addArgs) {
		var err = patchArgs[0] || removeArgs[0] || addArgs[0];
		if (err) return callback(err);
		client.createIndex('article', id, tags.concat(obj.title), callback);
	});
}

module.exports = patchArticle;
